摇摇八音盒

去年买了两个八音盒玩，上好发条，就能演奏一小段音乐。可惜翻来覆去就是一首(其实是半首不到，几十秒)，听几遍也就腻了。

某次看到VS1003居然支持MIDI格式，于是考虑用它做个播放器，把存在FLASH里的MIDI放出来。MIDI文件一般也就是几十kb，2M的SPIFLASH就够存几十首了。

最方便的把MIDI导入FLASH的方式肯定是U盘，所以MCU选了STM32F103，FLASH选了最常用的W25Q16。STM32F103的72M主频用一个定时器6分频得到12M，作为VS1003的主时钟，这样能省下一个晶振，缺点是12M/256=46.875k，这样没法支持48k采样率的音频文件。变通办法是在非USB状态把主频切到64M，然后5分频得到12.8M，需要USB时再切回72M，就是有点折腾。

两个USB口，其中一个用CH330N转串口用于调试。其实没必要，一个就够了。

VS1003的输出级可以直接驱动32欧耳机，所以不需要加功放IC了，两路各串10欧电阻然后并联，直连8欧喇叭。作为八音盒，这点音量也足够了。

开关J402的位置焊一个水银开关，调整它的方向让水银珠不要同时接触两电极，程序里用PA2的外部中断来唤醒MCU、进入播放状态，就实现了摇摇播放。如果要再复杂的手势控制之类，需要加个ADXL345之类的加速度传感器。

供电用一个一两百mAh的锂聚合物电池即可，简单配置了一下STM32F103的低功耗模式，进入低功耗模式前拉低VS1003的XRESET脚，可以把工作电流降到0.6mA左右，这样用200mAh的锂电池可以待机十几天。进一步优化应该可以把工作电流降到几十uA，实现几个月的待机时间。

实测播放MIDI的效果实在不怎么样……看来对VS1003的期望值不能太高。而且这东西原来只支持格式0的MIDI文件，其他格式需要转换；找了几个转换软件，要么不好用，要么得收费。那么还是用MP3文件吧，2M容量的W25Q16顿时不够用了。换成16M的W25Q128，再把MP3的码率压低些，这样也能放下十几首歌了。再试听，感觉音质好多了。

另一个麻烦在于往里面拷歌的速度实在太慢了，只有30~60KB/s。检查了一遍程序，发现原因是W25的4K扇区擦写周期要几十ms，大部分时间耗在这里了。如果改成32K扇区擦写显然会快很多，然而48脚的STM32F103C8只有20K的RAM，所以没办法了。下次再做还是得考虑用64K RAM的STM32F103RE之类。

源码链接如下，USB唤醒功能还没有做，有空再补上。
